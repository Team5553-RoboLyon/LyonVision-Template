plugins {
  id "edu.wpi.first.GradleRIO" version "2019.4.1"
}
apply plugin: 'cpp'
toolchainsPlugin.withRaspbian()

deploy {
  targets {
    target('coprocessor') {
      directory = '/home/vision'
      locations {
        // Change this if you've changed the target hostname, username or password.
        ssh {
          address = 'curtinvision.local'
          user = 'vision'
          password = 'curtinfrc'
        }
      }
    }
  }

  artifacts {
    nativeArtifact('vision') {
      targetPlatform = wpi.platforms.raspbian
      targets << 'coprocessor'
      component = 'curtinFrcVision'
      buildType = 'release'

      // Make sure we can run our program!
      postdeploy << { execute('chmod +x curtinFrcVision') }
    }

    // Some extra stuff for our vision program. Includes system configs, also!
    fileTreeArtifact('visionResources') {
      targets << 'coprocessor'
      files = fileTree(dir: 'src/main/resources')

      // Install the systemd service. This makes our vision run on startup!
      postdeploy << { 
        // Install a symlink for the service so the system can run it! A symlink is like a pointer for files
        execute('sudo ln -sf $(pwd)/system/vision.service /etc/systemd/system')
        if (project.hasProperty('stop')) {
          execute('sudo systemctl daemon-reload; sudo service vision stop; sudo service vision status')
        } else {
          // Reload the system services and start our vision service. Also print out the status :)
          execute('sudo systemctl daemon-reload; sudo service vision restart; sudo service vision status')
        }
      }

      // Configure the SSH server. Also backs up the ssh config
      postdeploy << {
        // Back up the stock sshd config, just in case!
        execute('sudo cp -n /etc/ssh/sshd_config /etc/ssh/sshd_config.old')
        // Replace the stock sshd config with ours (to allow X forwarding)
        execute('sudo cp $(pwd)/system/sshd_config /etc/ssh/sshd_config')
      }
    }

    // Store all the libraries in /home/vision/libraries, that way we don't poison /usr/local.
    withType(jaci.gradle.deploy.artifact.BinaryLibraryArtifact) {
      directory = '/home/vision/libraries'
      predeploy << {
        execute("sudo mkdir -p ${directory} && sudo chmod -R 777 ${directory}/..")
        // Make sure the system can find our libraries!
        execute("echo ${directory} | sudo tee /etc/ld.so.conf.d/vision.conf")
      }

      // Refresh the system's cache of known libraries, so ours can be found
      postdeploy << { execute('sudo ldconfig') }
    }
  }
}

model {
  components {
    curtinFrcVision(NativeExecutableSpec) {
      targetPlatform wpi.platforms.desktop
      targetPlatform wpi.platforms.raspbian

      sources.cpp {
        source {
          srcDir 'src/main/cpp'
        }
        exportedHeaders {
          srcDir 'src/main/include'
        }
      }

      useLibrary(it, 'opencv')
    }
  }
}

// Copie du dossier Data/ dans le dossier ou se trouve le programme Windows
task copyData(type: Copy) {
  from 'src'
  into 'build/install/curtinFrcVision/windowsx86-64/debug/lib'
  include 'data/***'
}

// La copie doit être executée après l'installation du programme (sinon le dossier est effacé)
copyData.mustRunAfter "installCurtinFrcVision${wpi.platforms.desktop.capitalize()}DebugExecutable"

task runVision(dependsOn: ["simulateCurtinFrcVision${wpi.platforms.desktop.capitalize()}DebugExecutable", "copyData"])